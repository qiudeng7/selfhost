services:
  # ==================== RSSHub ====================
  rsshub:
    image: diygod/rsshub:latest
    container_name: rsshub
    restart: unless-stopped
    ports:
      - 8081:1200
    environment:
      NODE_ENV: production
      # Puppeteer 配置
      PUPPETEER_WS_ENDPOINT: 'ws://browserless:3000'
      # GitHub Token（可选，推荐配置以提高 GitHub 路由稳定性）
      # GITHUB_ACCESS_TOKEN: 'your_github_token_here'
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:1200/healthz']
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      - browserless

  miniflux:
    image: miniflux/miniflux:latest
    ports:
      - "81:8080"
    depends_on:
      db:
        condition: service_healthy
    environment:
      - DATABASE_URL=postgres://miniflux:secret@db/miniflux?sslmode=disable
      - RUN_MIGRATIONS=1
      - CREATE_ADMIN=1
      - ADMIN_USERNAME=admin
      - ADMIN_PASSWORD=test123
  db:
    image: postgres:18
    environment:
      - POSTGRES_USER=miniflux
      - POSTGRES_PASSWORD=secret
      - POSTGRES_DB=miniflux
    volumes:
      - miniflux-db:/var/lib/postgresql
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "miniflux"]
      interval: 10s
      start_period: 30s

  browserless:
    image: browserless/chrome
    container_name: browserless
    restart: unless-stopped
    ulimits:
      core:
        hard: 0
        soft: 0
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/pressure']
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  miniflux-db: